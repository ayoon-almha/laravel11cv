//Experiment eligbility and conduction based on user profile
// User Profile
// {
// }
// exprObj:{
//   var interval = setInterval(function () {
window.Profile=window.Profile||{},window.Profile.Init=function(e,t,i,r,a){var n={PremiumStatus:"Not Started",VisitedStages:[],Country:r,Role:i,UserId:e,LayerId:t,Device:a}
"guest"!=i.toLowerCase()?window.Profile.UpdateProfile(n):localStorage.setItem("VisitedStagesInfo",JSON.stringify(n))},window.Profile.ConductExperiment=function(e,t){var i=0,r=setDefaultValues(e),a=JSON.parse(localStorage.getItem("VisitedStagesInfo"))
if(!a)return-1
var n=a.VisitedStages.filter(function(e){return e.userStageId==r.StageID}),o=!(!r.UseRole||"Guest"==r.UseRole)
if(r.conductforguestusers&&o)return i
if(!e.ignoreStageCheck&&!window.Profile.CheckStageEligibility(r.StageID))return i
if(e.isRCExperiment&&window.Profile.CheckTrialPurchaseDate(a.TrialPurchaseDate))return i
var s=!1
if(s=r.ExcludedCountry?-1==r.ExcludedCountry.indexOf(a.Country):r.Country.indexOf(a.Country)>-1||r.Country.toString().toUpperCase().includes("ALL"),!(r.Device.toString().toUpperCase().includes(a.Device.toUpperCase())&&s&&r.PremiumStatus.toString().toUpperCase().includes(a.PremiumStatus.toUpperCase())))return i
if(!e.ignoreStageCheck&&n&&n.length>0){var l=a.VisitedStages.indexOf(n[0]),u={userStageId:r.StageID,userStageDateTime:new Date}
a.VisitedStages[l]=u,localStorage.setItem("VisitedStagesInfo",JSON.stringify(a))}if(!r.IsBackend)return void 0!==window.experiment&&(i=window.experiment.conductUserExperiment(a.UserId,a.LayerId,r.ExprId).variant||0,t&&"function"==typeof t&&t(i)),i
conductBackendExperiment(a.UserId,r.ExprId,r.culture,r.logTraits,r.includeIterableIntegration,r.skipGoverning,t,!0)},window.Profile.UpdateUserPremiumStatus=function(e){var t=JSON.parse(localStorage.getItem("VisitedStagesInfo"))
t.PremiumStatus=e,localStorage.setItem("VisitedStagesInfo",JSON.stringify(t))},window.Profile.UpdateStage=function(e){var t=JSON.parse(localStorage.getItem("VisitedStagesInfo")),i=t.VisitedStages.filter(function(t){return t.userStageId==e}),r={userStageId:e,userStageDateTime:new Date}
if(i.length>0){var a=t.VisitedStages.indexOf(i[0])
t.VisitedStages[a]=r}else t.VisitedStages.push(r)
localStorage.setItem("VisitedStagesInfo",JSON.stringify(t))},window.Profile.UpdateLoginStatus=function(e){var t=JSON.parse(localStorage.getItem("VisitedStagesInfo"))
t&&(t.Role=e?"User":"Guest",localStorage.setItem("VisitedStagesInfo",JSON.stringify(t)))},window.Profile.UpdateProfile=function(e){if(!e&&localStorage.getItem("VisitedStagesInfo")&&(e=JSON.parse(localStorage.getItem("VisitedStagesInfo"))),e){var t=window.location.origin+"/api/v1/user/experimentprofile"
callAjaxExpProfile(t,"GET",!1,!0,function(t){if(t){var i=JSON.parse(t)
e.VisitedStages=i.UserStageLogs,e.PremiumStatus=i.PaymentStatus,e.TrialPurchaseDate=i.TrialPurchaseDate}localStorage.setItem("VisitedStagesInfo",JSON.stringify(e))},!1)}},window.Profile.CheckStageEligibility=function(e){var t=!0,i=JSON.parse(localStorage.getItem("VisitedStagesInfo")),r=i.VisitedStages.filter(function(t){return t.userStageId==e})
if(r&&r.length>0&&r[0].userStageDateTime){var a=new Date
Math.round((a-new Date(r[0].userStageDateTime))/864e5)<14&&(t=!1)}return t},window.Profile.CheckStgEligibilityAndReturnProfile=function(e){return{eligibility:window.Profile.CheckStageEligibility(e),UserProfile:JSON.parse(localStorage.getItem("VisitedStagesInfo"))}},window.Profile.CheckTrialPurchaseDate=function(e){if(!e)return!0
var t=!1,i=new Date
return Math.round((i-new Date(e))/864e5)>14&&(t=!0),t},window.Profile.UpdateTrialPurchaseDate=function(e){var t=JSON.parse(localStorage.getItem("VisitedStagesInfo"))
t.TrialPurchaseDate=e,localStorage.setItem("VisitedStagesInfo",JSON.stringify(t))},conductBackendExperiment=function(e,t,i,r,a,n,o,s){var l=window.location.origin+"/eb/api/v2/users/"+e+"/experiments/"+t+"/conduct"
if(!s){var l=window.location.hostname+"/eb/api/v2"
return fetch(l+"users/"+e+"/experiments/"+t+"/conduct",{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({logTraits:r,conductForOldUsers:!0,includeIterableIntegration:a,culture:i,skipGoverning:n})}).then(function(e){if(e.ok)return console.log(e.json()),e.json()})}callAjaxExpProfile(l,"POST",!1,!0,o,!1,JSON.stringify({logTraits:r,conductForOldUsers:!0,includeIterableIntegration:a,culture:i,skipGoverning:n}))},setDefaultValues=function(e){var t=e
return t.hasOwnProperty("PremiumStatus")||(t.PremiumStatus=["Not Started","Expired"]),t.hasOwnProperty("IsBackend")||(t.IsBackend=!1),t.hasOwnProperty("Country")||(t.Country=["ALL"]),t.hasOwnProperty("Device")||(t.Device="Desktop"),t.hasOwnProperty("culture")||(t.culture="en-US"),t.hasOwnProperty("ignoreStageCheck")||(t.ignoreStageCheck=!1),t.hasOwnProperty("isRCExperiment")||(t.isRCExperiment=!1),t},callAjaxExpProfile=function(e,t,i,r,a,n,o){var s
s=new XMLHttpRequest,s.onload=function(){4==s.readyState&&200==s.status?a&&(n?a(s.responseText,n):a(s.responseText)):4==s.readyState&&500==s.status&&a&&a("")},s.open(t,e,i),r&&(s.withCredentials=!0),o?(s.setRequestHeader("Content-Type","application/json;charset=UTF-8"),s.send(o)):s.send()}
